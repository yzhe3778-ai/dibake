<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Codex Studio</title>
  <style>
    :root {
      --bg-0: #06121f;
      --bg-1: #0a1d33;
      --bg-2: #0f2746;
      --star: rgba(255,255,255,0.18);
      --glass: rgba(255, 255, 255, 0.08);
      --glass-strong: rgba(255, 255, 255, 0.14);
      --border: rgba(255, 255, 255, 0.18);
      --text: #e8f2ff;
      --muted: #a9c1e6;
      --accent: #7fb2ff;
      --accent-2: #a9d0ff;
      --good: #6ae3c1;
      --warn: #ffcc66;
      --bad: #ff7a7a;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      --radius-lg: 22px;
      --radius-md: 14px;
      --radius-sm: 10px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "SF Pro Display", "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, #173a6a 0%, transparent 60%),
                  radial-gradient(900px 700px at 80% 0%, #0f2a52 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg-0), var(--bg-1) 35%, var(--bg-2));
      overflow: hidden;
    }

    .stars, .stars:after, .stars:before {
      content: "";
      position: absolute;
      inset: -50%;
      background-image: radial-gradient(var(--star) 1px, transparent 1px);
      background-size: 3px 3px;
      animation: drift 120s linear infinite;
      opacity: 0.5;
      pointer-events: none;
    }
    .stars:after {
      background-size: 4px 4px;
      opacity: 0.35;
      animation-duration: 160s;
    }
    .stars:before {
      background-size: 2px 2px;
      opacity: 0.25;
      animation-duration: 200s;
    }

    @keyframes drift { from { transform: translate3d(0,0,0); } to { transform: translate3d(5%, -8%, 0); } }

    .app {
      position: relative;
      height: 100%;
      display: grid;
      grid-template-rows: 64px 1fr;
    }

    .topbar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      padding: 0 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(10,18,32,0.7), rgba(10,18,32,0.35));
      backdrop-filter: blur(14px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      letter-spacing: 0.5px;
    }
    .brand .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8ad3ff, #4b8dff);
      box-shadow: 0 0 12px rgba(107, 174, 255, 0.9);
    }
    .brand .name {
      font-weight: 600;
      font-size: 15px;
      opacity: 0.95;
    }

    .mode-switch {
      display: inline-flex;
      gap: 6px;
      padding: 6px;
      border-radius: 999px;
      background: var(--glass);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .mode-btn {
      border: none;
      padding: 8px 16px;
      border-radius: 999px;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      transition: all .2s ease;
    }

    .mode-btn.active {
      background: rgba(255,255,255,0.16);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
    }

    .top-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .chip {
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--glass);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
    }

    .main {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 20px;
      padding: 20px;
      height: calc(100vh - 64px);
    }

    .main.chat-mode {
      grid-template-columns: 1fr;
    }

    .main.chat-mode .left {
      display: none;
    }

    .panel {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
    }

    .left {
      padding: 20px;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 16px;
      min-height: 0;
    }

    .section-title {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      background: rgba(8, 14, 28, 0.7);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      outline: none;
      font-size: 14px;
      line-height: 1.5;
      transition: border-color .2s ease;
    }

    textarea:focus { border-color: rgba(127,178,255,0.7); }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .field {
      background: rgba(8, 14, 28, 0.7);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 10px 12px;
      display: grid;
      gap: 6px;
    }

    .field label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    .field select, .field input {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    .quick-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .quick-chips button {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s ease;
    }
    .quick-chips button:hover { color: var(--text); border-color: var(--accent); }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .primary {
      flex: 1;
      padding: 12px 16px;
      border-radius: 14px;
      background: linear-gradient(135deg, #78b2ff, #4b8dff);
      color: #071321;
      font-weight: 700;
      border: none;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(75, 141, 255, 0.45);
      transition: transform .15s ease;
    }
    .primary:active { transform: translateY(1px) scale(0.99); }

    .ghost {
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      border: 1px solid var(--border);
      cursor: pointer;
    }

    .right {
      padding: 16px;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 12px;
      min-height: 0;
    }

    .status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
    }

    .debug {
      background: rgba(8, 14, 28, 0.6);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .debug summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--accent-2);
    }

    .debug pre {
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 160px;
      overflow: auto;
      margin: 8px 0 0;
    }

    .chat-header {
      display: none;
      justify-content: space-between;
      align-items: center;
      padding: 10px 6px;
      border-bottom: 1px solid var(--border);
    }

    .chat-title {
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .chat-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .chat-controls select, .chat-controls input {
      background: rgba(8, 14, 28, 0.7);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 12px;
      outline: none;
    }

    .results {
      overflow: auto;
      min-height: 0;
      display: grid;
      gap: 12px;
      grid-auto-rows: min-content;
      padding-right: 6px;
    }

    .results.chat-messages {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 8px 6px 14px;
    }

    .chat-input {
      display: none;
      gap: 10px;
      align-items: center;
      padding: 10px 6px;
      border-top: 1px solid var(--border);
    }

    .chat-input textarea {
      min-height: 46px;
      max-height: 120px;
      resize: none;
      border-radius: 16px;
      padding: 10px 12px;
      font-size: 13px;
    }

    .chat-input .primary {
      flex: 0 0 auto;
      padding: 10px 16px;
    }

    .main.chat-mode .chat-header,
    .main.chat-mode .chat-input {
      display: flex;
    }

    .card {
      background: rgba(8, 14, 28, 0.7);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 10px 24px rgba(0,0,0,0.35); }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .image-wrap img {
      width: 100%;
      border-radius: 12px;
      display: block;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .video-wrap video {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: #000;
    }

    .chat {
      display: grid;
      gap: 10px;
    }

    .bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
      line-height: 1.5;
      font-size: 13px;
    }

    .bubble.user { margin-left: auto; background: rgba(120,178,255,0.18); }
    .bubble.assistant { margin-right: auto; }

    .bubble.typing {
      font-style: italic;
      color: var(--muted);
    }

    .meta {
      display: flex;
      gap: 8px;
      color: var(--muted);
      font-size: 11px;
    }

    .badge {
      border-radius: 999px;
      padding: 4px 8px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .skeleton {
      height: 120px;
      border-radius: 12px;
      background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.12), rgba(255,255,255,0.05));
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .footer-note {
      font-size: 11px;
      color: var(--muted);
    }

    @media (max-width: 1100px) {
      .main { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <span class="name">Codex Studio</span>
      </div>

      <div class="mode-switch">
        <button class="mode-btn active" data-mode="image">图片</button>
        <button class="mode-btn" data-mode="video">视频</button>
        <button class="mode-btn" data-mode="chat">聊天</button>
      </div>

      <div class="top-actions">
        <span class="chip">星空蓝 · Apple Style</span>
      </div>
    </div>

    <div class="main" id="main">
      <div class="panel left">
        <div>
          <div class="section-title">Prompt</div>
          <textarea id="prompt" placeholder="描述你的创作需求…">一片星空下的未来城市，水面倒影清晰，宁静而宏伟</textarea>
        </div>

        <div id="paramBlock">
          <div class="section-title">参数</div>
          <div class="input-row" id="imageParams">
            <div class="field">
              <label>尺寸</label>
              <select id="imgSize">
                <option value="1024x1024">1024x1024</option>
                <option value="512x512">512x512</option>
                <option value="256x256">256x256</option>
              </select>
            </div>
            <div class="field">
              <label>数量</label>
              <input id="imgN" type="number" min="1" max="4" value="1" />
            </div>
          </div>

          <div class="input-row" id="videoParams" style="display:none;">
            <div class="field">
              <label>风格</label>
              <select id="videoStyle">
                <option>电影感</option>
                <option>梦境</option>
                <option>赛博</option>
              </select>
            </div>
            <div class="field">
              <label>时长(秒)</label>
              <input id="videoLen" type="number" min="3" max="15" value="6" />
            </div>
            <div class="field">
              <label>参考图 URL (可选)</label>
              <input id="videoImageUrl" type="text" placeholder="https://..." />
            </div>
            <div class="field">
              <label>上传图片 (可选)</label>
              <input id="videoImageFile" type="file" accept="image/*" />
            </div>
          </div>

          <div class="input-row" id="chatParams" style="display:none;">
            <div class="field">
              <label>角色</label>
              <select id="chatRole">
                <option value="assistant">助理</option>
                <option value="designer">设计师</option>
                <option value="director">导演</option>
              </select>
            </div>
            <div class="field">
              <label>温度</label>
              <input id="chatTemp" type="number" min="0" max="1" step="0.1" value="0.7" />
            </div>
          </div>
        </div>

        <div>
          <div class="section-title">快捷灵感</div>
          <div class="quick-chips">
            <button data-insert="星空蓝调的极简办公桌面">星空蓝桌面</button>
            <button data-insert="宁静海湾与蓝色极光">极光海湾</button>
            <button data-insert="超现实城市夜景，霓虹与雨">霓虹雨夜</button>
            <button data-insert="清晨薄雾中的玻璃建筑">玻璃建筑</button>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="generateBtn">生成</button>
          <button class="ghost" id="clearBtn">清空</button>
        </div>

        <div class="footer-note">密钥保存在前端，仅适合内测或本地使用。</div>
      </div>

      <div class="panel right">
        <div class="status">
          <div>状态: <span id="statusText">空闲</span></div>
          <div class="meta">
            <span class="badge" id="modeBadge">图片</span>
            <span class="badge" id="countBadge">0</span>
          </div>
        </div>
        <details class="debug" id="debugPanel">
          <summary>诊断信息</summary>
          <pre id="debugLog">暂无</pre>
        </details>
        <div class="chat-header" id="chatHeader">
          <div class="chat-title">交互对话</div>
          <div class="chat-controls">
            <select id="chatRoleInline">
              <option value="assistant">助理</option>
              <option value="designer">设计师</option>
              <option value="director">导演</option>
            </select>
            <input id="chatTempInline" type="number" min="0" max="1" step="0.1" value="0.7" />
            <button class="ghost" id="chatClearBtn">清空</button>
          </div>
        </div>
        <div class="results" id="results"></div>
        <div class="chat-input" id="chatInputBar">
          <textarea id="chatInput" placeholder="输入内容，回车发送；Shift+Enter 换行"></textarea>
          <button class="primary" id="chatSendBtn">发送</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://gork2api.zeabur.app";
    const API_KEY = "Bearer zAiLCJuZXQiOiJ3cyIsInBhdGgiOiJkM2Q2MzI4M";

    const modeButtons = document.querySelectorAll(".mode-btn");
    const mainEl = document.getElementById("main");
    const promptEl = document.getElementById("prompt");
    const results = document.getElementById("results");
    const statusText = document.getElementById("statusText");
    const modeBadge = document.getElementById("modeBadge");
    const countBadge = document.getElementById("countBadge");

    const imageParams = document.getElementById("imageParams");
    const videoParams = document.getElementById("videoParams");
    const chatParams = document.getElementById("chatParams");

    const chatInputBar = document.getElementById("chatInputBar");
    const chatInput = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");
    const chatClearBtn = document.getElementById("chatClearBtn");

    const chatRoleInline = document.getElementById("chatRoleInline");
    const chatTempInline = document.getElementById("chatTempInline");

    const videoImageUrlEl = document.getElementById("videoImageUrl");
    const videoImageFileEl = document.getElementById("videoImageFile");
    const debugLog = document.getElementById("debugLog");

    let currentMode = "image";
    let chatHistory = [];
    let videoImageDataUrl = "";

    const models = {
      image: "grok-imagine-1.0",
      video: "grok-imagine-1.0-video",
      chat: "grok-4.1"
    };

    async function resolveModels() {
      try {
        const res = await fetch(API_BASE + "/v1/models", {
          headers: { "Authorization": API_KEY }
        });
        if (!res.ok) return;
        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (err) {}
        if (!data?.data) return;
        const ids = (data.data || []).map(m => m.id);
        if (!ids.includes(models.image)) {
          if (ids.includes("grok-imagine-1.0")) models.image = "grok-imagine-1.0";
          else if (ids.includes("grok-imagine-0.9")) models.image = "grok-imagine-0.9";
        }
        if (!ids.includes(models.video)) {
          if (ids.includes("grok-imagine-1.0-video")) models.video = "grok-imagine-1.0-video";
          else if (ids.includes("grok-imagine-0.9")) models.video = "grok-imagine-0.9";
        }
        if (!ids.includes(models.chat)) {
          if (ids.includes("grok-4.1")) models.chat = "grok-4.1";
          else if (ids.includes("grok-4-fast")) models.chat = "grok-4-fast";
        }
      } catch (err) {
        // ignore and keep defaults
      }
    }

    function setMode(mode) {
      currentMode = mode;
      modeButtons.forEach(btn => btn.classList.toggle("active", btn.dataset.mode === mode));
      imageParams.style.display = mode === "image" ? "grid" : "none";
      videoParams.style.display = mode === "video" ? "grid" : "none";
      chatParams.style.display = mode === "chat" ? "grid" : "none";
      modeBadge.textContent = mode === "image" ? "图片" : mode === "video" ? "视频" : "聊天";
      mainEl.classList.toggle("chat-mode", mode === "chat");
      results.classList.toggle("chat-messages", mode === "chat");
      chatInputBar.style.display = mode === "chat" ? "flex" : "none";
      setStatus("空闲");
      results.innerHTML = "";
      countBadge.textContent = "0";
    }

    function setStatus(text, type) {
      statusText.textContent = text;
      statusText.style.color = type === "good" ? "var(--good)" : type === "bad" ? "var(--bad)" : "var(--muted)";
    }

    function addSkeleton(count = 2) {
      results.innerHTML = "";
      for (let i = 0; i < count; i++) {
        const sk = document.createElement("div");
        sk.className = "card skeleton";
        results.appendChild(sk);
      }
    }

    function normalizeAssetUrl(url) {
      if (!url) return "";
      if (url.startsWith("data:")) return url;
      if (url.startsWith("http://") || url.startsWith("https://")) return url;
      if (url.startsWith("/")) return API_BASE + url;
      return API_BASE + "/" + url;
    }

    function normalizeB64Image(b64) {
      if (!b64) return "";
      if (b64.startsWith("data:")) return b64;
      return `data:image/png;base64,${b64}`;
    }

    function extractImageUrls(text) {
      const urls = [];
      if (!text) return urls;
      const mdMatches = text.matchAll(/!\[[^\]]*\]\(([^)]+)\)/g);
      for (const m of mdMatches) urls.push(m[1]);
      const htmlMatches = text.matchAll(/<img[^>]*src=["']([^"']+)["'][^>]*>/gi);
      for (const m of htmlMatches) urls.push(m[1]);
      const rawMatches = text.matchAll(/https?:\/\/[^\s)]+/g);
      for (const m of rawMatches) urls.push(m[0]);
      return Array.from(new Set(urls));
    }

    function extractVideoSrc(text) {
      if (!text) return "";
      const match = text.match(/<video[^>]*src=["']([^"']+)["'][^>]*>/i);
      if (match && match[1]) return match[1];
      const raw = text.match(/https?:\/\/[^\s)]+/);
      return raw ? raw[0] : "";
    }

    function renderChat(withTyping = false) {
      results.innerHTML = "";
      const chatWrap = document.createElement("div");
      chatWrap.className = "chat";
      chatHistory.forEach(msg => {
        const bubble = document.createElement("div");
        bubble.className = "bubble " + (msg.role === "user" ? "user" : "assistant");
        bubble.textContent = msg.content;
        chatWrap.appendChild(bubble);
      });
      if (withTyping) {
        const typing = document.createElement("div");
        typing.className = "bubble assistant typing";
        typing.textContent = "正在输入…";
        chatWrap.appendChild(typing);
      }
      results.appendChild(chatWrap);
      results.scrollTop = results.scrollHeight;
    }

    function writeDebug(payload) {
      if (!debugLog) return;
      debugLog.textContent = JSON.stringify(payload, null, 2);
    }

    async function request(path, body) {
      const url = API_BASE + path;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": API_KEY
        },
        body: JSON.stringify(body)
      });
      const contentType = res.headers.get("content-type") || "";
      const text = await res.text();
      let json = null;
      let sseData = "";

      if (text) {
        if (contentType.includes("text/event-stream") || text.trim().startsWith("data:")) {
          const lines = text.split(/\r?\n/).map(line => line.trim()).filter(Boolean);
          const dataLines = lines
            .filter(line => line.startsWith("data:"))
            .map(line => line.slice(5).trim())
            .filter(line => line && line !== "[DONE]");
          if (dataLines.length) {
            const last = dataLines[dataLines.length - 1];
            try { json = JSON.parse(last); } catch (err) { sseData = last; }
          }
        } else {
          try { json = JSON.parse(text); } catch (err) {}
        }
      }
      writeDebug({
        request: { url, body },
        response: {
          status: res.status,
          contentType,
          text: text ? text.slice(0, 2000) : ""
        }
      });
      if (!res.ok) {
        const errMsg = json?.error?.message || sseData || text || res.statusText;
        throw new Error(errMsg);
      }
      if (json) return json;
      if (sseData) return { data: sseData };
      return text ? { data: text } : {};
    }

    async function requestImage(prompt, size, n) {
      try {
        return await request("/v1/images/generations", {
          model: models.image,
          prompt,
          n,
          size,
          response_format: "b64_json"
        });
      } catch (err) {
        try {
          return await request("/v1/images/generations", {
            model: models.image,
            prompt,
            n,
            size: "1024x1024"
          });
        } catch (err2) {
          throw err;
        }
      }
    }

    async function generate() {
      const prompt = (currentMode === "chat" ? chatInput.value : promptEl.value).trim();
      if (!prompt) return;

      if (currentMode === "chat") {
        renderChat(true);
      } else {
        addSkeleton();
      }
      setStatus("生成中…");

      try {
        if (currentMode === "image") {
          const size = document.getElementById("imgSize").value;
          const n = Number(document.getElementById("imgN").value || 1);
          let data;
          try {
            data = await requestImage(prompt, size, n);
          } catch (err) {
            const fallback = await request("/v1/chat/completions", {
              model: models.chat,
              messages: [{ role: "user", content: `请生成图片：${prompt}` }]
            });
            const content = fallback?.choices?.[0]?.message?.content || "";
            const urls = extractImageUrls(content).map(normalizeAssetUrl);
            if (!urls.length) throw err;
            data = { data: urls.map(url => ({ url })) };
          }

          results.innerHTML = "";
          const grid = document.createElement("div");
          grid.className = "grid";
          (data.data || []).forEach((item, idx) => {
            const card = document.createElement("div");
            card.className = "card image-wrap";
            const img = document.createElement("img");
            const src = item.url ? normalizeAssetUrl(item.url) : normalizeB64Image(item.b64_json);
            if (!src) {
              card.textContent = "图片返回为空";
            } else {
              img.src = src;
              img.alt = `image-${idx}`;
              card.appendChild(img);
            }
            grid.appendChild(card);
          });
          results.appendChild(grid);
          countBadge.textContent = String((data.data || []).length);
        }

        if (currentMode === "video") {
          const videoModel = models.video;
          const style = document.getElementById("videoStyle").value;
          const len = document.getElementById("videoLen").value;
          let messages;
          let imageUrl = videoImageDataUrl || videoImageUrlEl.value.trim();

          if (videoModel === "grok-imagine-0.9") {
            if (!imageUrl) throw new Error("视频生成需要参考图。请上传图片或填写图片 URL。");
            messages = [{
              role: "user",
              content: [
                { type: "text", text: `${prompt} | 风格: ${style} | 时长: ${len}s` },
                { type: "image_url", image_url: { url: imageUrl } }
              ]
            }];
          } else {
            messages = [{ role: "user", content: `${prompt} | 风格: ${style} | 时长: ${len}s` }];
          }

          const data = await request("/v1/chat/completions", {
            model: videoModel,
            messages,
            stream: false
          });

          results.innerHTML = "";
          const card = document.createElement("div");
          card.className = "card video-wrap";
          const video = document.createElement("video");
          video.controls = true;
          let content = data?.choices?.[0]?.message?.content ?? data?.data ?? "";
          if (Array.isArray(content)) {
            const found = content.find(part => part?.type === "video_url" || part?.type === "text");
            content = found?.video_url?.url || found?.text || "";
          } else if (typeof content === "object" && content !== null) {
            content = content.url || content.video_url || "";
          }
          const src = normalizeAssetUrl(extractVideoSrc(content) || content);
          if (!src) {
            throw new Error("视频返回为空或格式异常，请检查模型与返回格式。");
          }
          video.src = src;
          card.appendChild(video);
          results.appendChild(card);
          countBadge.textContent = "1";
        }

        if (currentMode === "chat") {
          const role = chatRoleInline.value;
          const temp = Number(chatTempInline.value || 0.7);

          chatHistory.push({ role: "user", content: prompt });

          const data = await request("/v1/chat/completions", {
            model: models.chat,
            temperature: temp,
            stream: false,
            messages: [
              { role: "system", content: `你是一个${role}风格的助手，回答简洁、有创意。` },
              ...chatHistory
            ]
          });

          const reply = data?.choices?.[0]?.message?.content || data?.data || "";
          chatHistory.push({ role: "assistant", content: reply });
          renderChat(false);
          countBadge.textContent = String(chatHistory.length);
          chatInput.value = "";
        }

        setStatus("完成", "good");
      } catch (err) {
        results.innerHTML = `
          <div class="card">
            <div style="color: var(--bad); font-weight: 600;">请求失败</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 6px;">${String(err).slice(0, 240)}</div>
          </div>`;
        setStatus("失败", "bad");
      }
    }

    document.getElementById("generateBtn").addEventListener("click", generate);
    document.getElementById("clearBtn").addEventListener("click", () => {
      promptEl.value = "";
      results.innerHTML = "";
      chatHistory = [];
      setStatus("空闲");
      countBadge.textContent = "0";
    });

    chatSendBtn.addEventListener("click", generate);
    chatClearBtn.addEventListener("click", () => {
      chatHistory = [];
      renderChat(false);
      countBadge.textContent = "0";
      setStatus("空闲");
    });

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        generate();
      }
    });

    videoImageFileEl.addEventListener("change", async () => {
      const file = videoImageFileEl.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        videoImageDataUrl = String(reader.result || "");
        videoImageUrlEl.value = file.name;
      };
      reader.readAsDataURL(file);
    });

    document.querySelectorAll(".quick-chips button").forEach(btn => {
      btn.addEventListener("click", () => {
        promptEl.value = btn.dataset.insert;
      });
    });

    modeButtons.forEach(btn => btn.addEventListener("click", () => setMode(btn.dataset.mode)));
    setMode("image");
    resolveModels();
  </script>
</body>
</html>
